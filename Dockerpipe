#!/usr/bin/env groovy

properties([
    [$class: 'BuildDiscarderProperty', strategy: [
        $class: 'LogRotator',
        numToKeepStr: '5',
        daysToKeepStr: '5'
    ]]
])

node { ansiColor('xterm') { timestamps {
    try {
        stage ('Checkout') {
            sh 'printenv'
            checkout scm
            sh 'git clean -fdx'
        }

        stage ('Initialise') {
            sh 'make docker-init'
        }

        stage ('Test') {
            sh 'make docker-test'
        }
    } finally {
        stage('Clean Up') {
            sh 'docker-compose down --remove-orphans'
            cleanWs()
        }
    }
} } }

if (env.BRANCH_NAME ==~ /^(master)$/) {
    stage ('Deploy to Production') {
        build job: "Deploymentpipe/phpwkhtmltopdf-server/$BRANCH_NAME",
            parameters: [
                string(name: 'TERRAFORM_BACKEND', value: 'production'),
                string(name: 'TERRAFORM_WORKSPACE', value: 'production'),
                string(name: 'DOCKER_REPO', value: '428466588005.dkr.ecr.eu-west-1.amazonaws.com/phpwkhtmltopdf-server'),
                string(name: 'REGION', value: 'eu-west-1'),
            ],
            wait: true
    }
}
